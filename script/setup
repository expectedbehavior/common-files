#!/bin/bash
set -e
cd "$(dirname "$0")/.."

setup_echo() {
  echo "[script/setup] $1"
}

setup_error() {
  echo "[script/setup][ERROR] $1"
}


setup_echo "SYSTEM PREFERENCES"
setup_echo "Some suggested system preference changes"
setup_echo
setup_echo "Trackpad > Tap to click"
setup_echo "Keyboard > Keyboard > Repeat to fast"
setup_echo "Keyboard > Keyboard > Delay to short"
setup_echo "Keyboard > Modifier Keys > Set Caps Lock to Control"
setup_echo "Keyboard > Shortcuts > Mission Control > Uncheck Mission control (conflicts with atom emacs navigation)"
setup_echo "Keyboard > Shortcuts > Mission Control > Uncheck Application windows (conflicts with atom emacs navigation)"
setup_echo "Keyboard > Shortcuts > Mission Control > Uncheck Move left a space (conflicts with atom emacs navigation)"
setup_echo "Keyboard > Shortcuts > Mission Control > Uncheck Move right a space (conflicts with atom emacs navigation)"
setup_echo "Security & Privacy > General > Require password >5 seconds< after sleep..."
setup_echo "Energy Saver > Battery > Turn display off after: 1 hour"
setup_echo "Energy Saver > Power Adapter > Turn display off after: never # so installs don't get cut off"
setup_echo "Sharing > Click Edit, Change hostname"
setup_echo "Sharing> Check 'Remote Login' checkbox on left"
setup_echo "Dock > Automatically hide and show the Dock"
setup_echo "Date & Time > Clock > Time options > Display the time with seconds"
setup_echo "Date & Time > Clock > Date options > Show date"
setup_echo "Users & Groups > Guest User > Uncheck Allow guests to log into this computer so that I don't get prompted on every computer restart."
setup_echo "General > Uncheck Close windows when quitting an app (so iTerm restores previous windows)"
setup_echo "Desktop & Screen Saver > Screen Saver > Start after: never"
setup_echo "Hot Corners: bottom right => Put Display to Sleep"
setup_echo "Sound > Check Show volume in menu bar"
setup_echo "Touch ID > Add my left index fingerprint in case I'm holding something in my right hand."
setup_echo "iCloud > iCloud Drive Options > Uncheck 'Optimize Mac Storage'"
setup_echo
setup_echo "When you're done changing your system preferences, hit enter"
read system_preferences_finished

# TODO: remove this block from Instrumental script/setup when CF is fully required
if ! which brew > /dev/null 2>&1; then
  setup_echo "Installing homebrew"
  /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
fi


brew_install() {
  setup_echo "Installing $1"
  brew list $1 > /dev/null || brew install $1
}

brew_cask_install() {
  setup_echo "Installing $1"
  brew cask list $1 > /dev/null || brew cask install $1
}


brew_cask_install dropbox
setup_echo "If your code is in dropbox, now's the time to start syncing. After this, the script will start installing the default software and you'll be handsoff for a while. Hit enter when ready."
read post_dropbox_install


brew_install mas
#apple_id_email_address=$(dscl . readpl /Users/`whoami` dsAttrTypeNative:LinkedIdentity appleid.apple.com:linked\ identities:0:full\ name | awk -F ':' '{print $5}')
# mas signin --dialog $apple_id_email_address
setup_echo "There's current no way to automatically sign you into the Apple Store. You'll need to open it and manually sign in. Hit enter when you've done that."
read apple_store_signedin

brew tap Homebrew/bundle
sudo xcodebuild -license accept
brew bundle --verbose




# System Preferences > Desktop & Screen Saver > Start after: Never
defaults -currentHost write com.apple.screensaver idleTime -int 0

# System Preferences > Dock > Automatically hide and show the Dock:
defaults write com.apple.dock autohide -bool true

# System Preferences > Keyboard >
defaults write NSGlobalDomain KeyRepeat -int 2

# System Preferences > Keyboard >
defaults write NSGlobalDomain InitialKeyRepeat -int 15

# System Preferences > Trackpad > Tap to click
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad Clicking -bool true

# Finder > View > Show Path Bar
defaults write com.apple.finder ShowPathbar -bool true

# Finder > View > As List
defaults write com.apple.finder FXPreferredViewStyle -string "Nlsv"


# Kill affected apps
for app in "Dock" "Finder"; do
  killall "${app}" > /dev/null 2>&1
done





setup_echo "Install EB dotfiles"
.common_files/stow/script/setup
